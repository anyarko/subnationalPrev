```{r, loading_libs}
library(ggplot2)
library(dplyr)
library(stringr)
library(rio)
library(gridExtra)
options(scipen=999)

source('utils.r')
```

```{r, visualising_saved_results}
narrow.degree.prior <- import('results/mu_rho_2.5_6.5_seeds_427_41.csv')
narrow.degree.prior %>% 
group_by(model, num_respondents) %>% 
summarise(mean(mean_error)) #%>% 
filter(model=='negative_binomial')

wide.degree.prior <- import('results/mu_rho_2.5_6.5_seeds_2_71_920_delta_a_b_cauchy.csv')
wide.degree.prior %>%
group_by(model, num_respondents) %>%
summarise(mean(mean_error)) #%>%
filter(model=='negative_binomial')

narrow.boxplot <- narrow.degree.prior %>% 
ggplot(aes(x=as.factor(num_respondents), y=mean_error, 
           color=sub('_', ' ', model) %>% str_to_title())) +
geom_boxplot() +
labs(x='Number of respondents', 
     y='Mean Absolute Relative Error',
     color='Model') +
expand_limits(x=0, y=0) +
scale_y_continuous(breaks = seq(0, 2, length.out=9), 
                   limits=c(0, 2)) +
geom_hline(yintercept=0, linetype='dashed', color='red') +
theme_bw() +
theme(legend.position = 'bottom') 

narrow.scatter <- narrow.degree.prior %>%
group_by(model, num_respondents) %>%
summarise(mean_error = mean(mean_error)) %>%
ggplot(aes(x=num_respondents, y=mean_error, 
           color=sub('_', ' ', model) %>% str_to_title())) +
geom_point(size=3) +
labs(x='Number of respondents per region', 
     y='Mean Absolute Relative Error',
     color='Model') +
expand_limits(x=0, y=0) +   
scale_y_continuous(breaks = seq(0, 1.5, length.out=7), limits=c(0, 1.5)) +
scale_x_continuous(limits = c(0, 100)) +
geom_hline(yintercept=0, linetype='dashed', color='red') +
theme_bw() +
theme(legend.position = 'bottom')

narrow.boxplot.scatter <- grid.arrange(narrow.boxplot, 
                  narrow.scatter, ncol=2, widths=c(10,8))

# ggsave('visualisations/narrow_degree_prior_boxplot_scatter.pdf', 
#        plot= narrow.boxplot.scatter, width=9, height=5, units='in')                  
```


```{r, combining_saved_results_multiple_seeds}
folder.name <- 'results/old_tau/scott/'
folder.name <- 'results/same_rho_j/'
folder.name <- 'results/delta_10_5/more_respondents/'
errors.file.names <- list.files(folder.name, pattern='^seeds')
all.spatial.results <- matrix(0, ncol=4) %>% as.data.frame()
colnames(all.spatial.results) <- c('num_respondents', 'mean_error', 'model', 'seed')

for(file in errors.file.names){
  spatial.results <- import(paste(folder.name, file, sep=''))
  spatial.results$seed <- as.numeric(str_extract(file, '\\d+'))
  print(as.numeric(str_extract(file, '\\d+')))
  all.spatial.results <- rbind(all.spatial.results, spatial.results)
}

all.spatial.results <- all.spatial.results[-1,] %>% mutate_at(vars(-model, -seed), as.numeric)
all.spatial.results %>% str
```


```{r, visualising_combined_results_multiple_seeds}
mean.errors <- all.spatial.results %>% group_by(seed, model, num_respondents) %>% 
summarise(mean_error = mean(mean_error)) 

mean.errors %>% 
ggplot(aes(x=num_respondents, y=mean_error, 
           color=sub('_', ' ', model) %>% str_to_title())) +
geom_jitter(width=0.1, size=2) +
labs(x='Number of respondents', 
     y='Mean Absolute Relative Error',
     color='Model') +
expand_limits(x=0, y=0) +   
scale_y_continuous(breaks = seq(0, 4, length.out=17), limits=c(0, 4)) +
geom_hline(yintercept=0, linetype='dashed', color='red') +
theme_bw() +
theme(legend.position = 'bottom')

all.spatial.results %>% group_by(seed, model, num_respondents) %>%
ggplot(aes(x=as.factor(num_respondents), y=mean_error, 
           color=sub('_', ' ', model) %>% str_to_title())) +
geom_boxplot() +
labs(x='Number of respondents', 
     y='Mean Absolute Relative Error',
     color='Model') +
expand_limits(x=0, y=0) +
scale_y_continuous(breaks = seq(0, 4, length.out=17), 
                   limits=c(0, 4)) +
geom_hline(yintercept=0, linetype='dashed', color='red') +
theme_bw() +
theme(panel.grid.major.x = element_blank(), panel.grid.minor = element_blank(), legend.position = 'bottom')
```


```{r, visualising_both_estimators_different_respondents_same_data}
spatial.results %>% filter(model=='negative_binomial')
spatial.results %>% 
ggplot(aes(x=num_respondents, y=mean_error, 
           color=sub('_', ' ', model) %>% str_to_title())) +
geom_point(size=3) +
labs(x='Number of respondents', 
     y='Mean Absolute Relative Error',
     color='Model') +
expand_limits(x=0, y=0) +   
scale_y_continuous(breaks = seq(0, 1.5, length.out=7), limits=c(0, 1.5)) +
geom_hline(yintercept=0, linetype='dashed', color='red') +
theme_bw() +
theme(legend.position = 'bottom')

full.

spatial.results %>% group_by(model, num_respondents) %>% 
summarise(mean_error = mean(mean_error))



ggplot(aes(x=as.factor(num_respondents), y=mean_error, 
           color=sub('_', ' ', model) %>% str_to_title())) +
geom_boxplot() +
labs(x='Number of respondents', 
     y='Mean Absolute Relative Error',
     color='Model') +
expand_limits(x=0, y=0) +
scale_y_continuous(breaks = seq(0, 2, length.out=9), 
                   limits=c(0, 2)) +
geom_hline(yintercept=0, linetype='dashed', color='red') +
theme_bw() +
theme(legend.position = 'bottom') 

# write.csv(full.spatial.results, 'results/mu_rho_2.5_6.5_seeds.csv', row.names=F)
# ggsave('visualisations/boxplot_mu_rho_2.5_6.5_seeds_427_41.pdf', width=7, height=8, units='in')
# ggsave('visualisations/scatter_mu_rho_2.5_6.5_seeds_427_41.pdf', width=6, height=5, units='in')
```

